<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Objective Question Self-Practice</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for a clean look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- html2canvas CDN for converting HTML to canvas/image (for PDF generation) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF CDN for generating PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* Base styles for body and container */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to the top for better scrolling */
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            position: relative; /* Needed for floating button positioning */
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 10; /* Ensure container is above modal background */
        }

        /* Generic button styles */
        .btn {
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            text-align: center;
        }
        .btn-primary {
            background-color: #6366f1;
            color: #ffffff;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }
        .btn-primary:hover {
            background-color: #4f46e5;
            transform: translateY(-2px);
        }
        .btn-primary:active {
            transform: translateY(0);
        }

        /* Question card styling */
        .question-card {
            background-color: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            margin-bottom: 15px;
        }
        .question-card p.question-text {
            font-size: 1.15rem;
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 15px;
        }
        .question-card .option label {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .question-card .option label:hover {
            background-color: #eff6ff;
            border-color: #a7b4f5;
        }
        .question-card .option input[type="radio"] {
            margin-right: 12px;
            accent-color: #6366f1; /* Custom color for radio button */
            transform: scale(1.2); /* Slightly larger radio button */
        }

        /* Loading spinner animation */
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #6366f1;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none; /* Hidden by default, shown by JS */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Results section styling */
        .results-section {
            background-color: #ecfdf5; /* Light green background */
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #a7f3d0; /* Green border */
            text-align: center;
            display: none; /* Hidden by default, shown by JS */
        }
        .results-section h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #065f46; /* Dark green text */
            margin-bottom: 10px;
        }
        .results-section p {
            font-size: 1.1rem;
            color: #065f46;
        }

        /* Error message styling */
        .error-message {
            color: #ef4444; /* Red color for errors */
            background-color: #fee2e2;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #fca5a5;
            margin-top: 15px;
            display: none; /* Hidden by default, shown by JS */
            font-weight: 500;
        }

        /* Floating button specific styles */
        .floating-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background-color: #6366f1;
            color: #ffffff;
            font-weight: 800;
            padding: 16px 32px;
            border-radius: 9999px;
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.4);
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            z-index: 50;
        }
        .floating-button:hover {
            background-color: #4f46e5;
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 15px 30px rgba(99, 102, 241, 0.5);
        }
        .floating-button:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3);
        }
        .floating-button svg {
            width: 24px;
            height: 24px;
            margin-right: 8px;
        }

        /* Modal overlay and content styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 60;
            opacity: 0; /* Initial opacity for fadeIn animation */
            animation: fadeIn 0.3s ease-out forwards;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 32px;
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 448px;
            transform: translateY(20px) scale(0.95);
            animation: slideUp 0.3s ease-out forwards;
            position: relative;
            z-index: 70;
        }
        .modal-content h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 24px;
            text-align: center;
        }
        /* Input group labels in modal */
        .modal-content .input-group label {
            font-size: 1.125rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            display: block;
        }
        /* Input group fields in modal */
        .modal-content .input-group input,
        .modal-content .input-group select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            font-size: 1rem;
            color: #4b5563;
            transition: border-color 0.2s ease;
        }
        .modal-content .input-group input:focus, .modal-content .input-group select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        /* Modal buttons container */
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            margin-top: 28px;
        }
        /* Cancel button in modal */
        .btn-cancel {
            background-color: #e5e7eb;
            color: #374151;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 12px;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        .btn-cancel:hover {
            background-color: #d1d5db;
        }
        /* Generate button in modal */
        .btn-generate {
            background-color: #10b981;
            color: #ffffff;
            font-weight: 800;
            padding: 12px 24px;
            border-radius: 12px;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
        }
        .btn-generate:hover {
            background-color: #059669;
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.4);
        }

        /* Timer and Score display box */
        .timer-score-box {
            background-color: #e0f2fe;
            padding: 16px;
            border-radius: 8px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .timer-score-box .label {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e40af;
        }
        .timer-score-box .value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* Styling for correct/incorrect/unanswered question cards */
        .question-card.correct {
            border-color: #10B981; /* green-500 */
            background-color: #ECFDF5; /* green-50 */
        }
        .question-card.incorrect {
            border-color: #EF4444; /* red-500 */
            background-color: #FEE2E2; /* red-50 */
        }
        .question-card.unanswered {
            border-color: #F59E0B; /* yellow-500 */
            background-color: #FFFBEB; /* yellow-50 */
        }

        /* Styling for correct/incorrect options within question cards */
        .option label.correct-option {
            background-color: #D1FAE5 !important; /* light green */
            border-color: #34D399 !important; /* green-400 */
            font-weight: 600;
        }
        .option label.selected-incorrect-option {
            background-color: #FEE2E2 !important; /* light red */
            border-color: #EF4444 !important; /* red-400 */
            font-weight: 600;
        }

        /* Elements to hide during PDF generation */
        .hide-on-pdf {
            /* This class will be programmatically controlled by JS to hide elements
               like buttons, timer, and modal during PDF capture. */
        }

        /* CSS animations for modal transitions */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container" id="main-content-for-pdf">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">📝 Objective Question Generator</h1>

        <!-- Timer and Score Display - Hidden by default, shown when quiz starts -->
        <div id="timer-score-display" class="timer-score-box hidden hide-on-pdf">
            <div class="label">
                Time Left: <span id="time-left" class="value text-blue-800">00:00</span>
            </div>
            <div id="quiz-score-summary" class="label hidden">
                Your Score: <span id="score-value" class="value text-purple-800">0 / 0</span>
            </div>
        </div>

        <!-- Initial Message - Visible on page load until quiz is generated -->
        <div id="initial-message" class="text-center py-12">
            <p class="text-xl text-gray-500 font-medium">
                Click the "Create Quiz" button to generate a new quiz!
            </p>
            <p class="mt-2 text-md text-gray-400">
                You can specify the topic and number of questions.
            </p>
        </div>

        <!-- Loading Indicator - Shown while fetching questions from API -->
        <div id="loading-spinner" class="loading-spinner"></div>

        <!-- Error Message Display - Shown if API call fails or inputs are invalid -->
        <div id="error-message" class="error-message">
            <strong class="font-bold">Error!</strong>
            <span id="error-text" class="block sm:inline ml-2"></span>
        </div>

        <!-- Quiz Questions Area - Dynamically populated by JavaScript -->
        <div id="quiz-questions-area" class="mt-5">
            <!-- Questions will be loaded here -->
        </div>

        <!-- Submit Quiz Button - Hidden by default, shown when quiz questions are loaded -->
        <div id="submit-quiz-button-container" class="flex justify-center mt-4 hidden hide-on-pdf">
            <button id="submit-quiz-btn" class="btn btn-primary w-full max-w-xs">Submit Answers</button>
        </div>

        <!-- Quiz Result and Action Buttons - Hidden by default, shown after quiz submission -->
        <div id="quiz-result-actions" class="results-section mt-5 hidden">
            <h2 class="text-3xl font-bold text-gray-900">Quiz Completed!</h2>
            <p id="final-score-text" class="text-xl font-bold text-green-600 mb-4"></p>
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 hide-on-pdf">
                <button id="create-new-quiz-btn" class="btn btn-primary bg-blue-600 hover:bg-blue-700 w-full sm:w-auto">
                    Create New Quiz
                </button>
                <button id="download-quiz-btn" class="btn btn-primary bg-gray-700 hover:bg-gray-800 w-full sm:w-auto">
                    Download Quiz (PDF)
                </button>
            </div>
        </div>
    </div>

    <!-- Floating Create Quiz Button - Always visible, triggers modal -->
    <button id="floating-create-quiz-btn" class="floating-button hide-on-pdf">
        <svg class="w-6 h-6 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
        Create Quiz
    </button>

    <!-- Quiz Generation Modal - Hidden by default, shown on button click -->
    <div id="quiz-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">Generate New Quiz</h2>

            <div class="input-group mb-5">
                <label for="modal-topic-input">Quiz Topic:</label>
                <input
                    type="text"
                    id="modal-topic-input"
                    placeholder="e.g., World History, Science, JavaScript"
                    class="focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
                    autofocus
                />
            </div>

            <div class="input-group mb-7">
                <label for="modal-num-questions-select">Number of Questions:</label>
                <select
                    id="modal-num-questions-select"
                    class="focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
                >
                    <option value="10">10 Questions</option>
                    <option value="20">20 Questions</option>
                    <option value="30">30 Questions</option>
                    <option value="40">40 Questions</option>
                    <option value="50">50 Questions</option>
                    <option value="60">60 Questions</option>
                    <option value="70">70 Questions</option>
                    <option value="80">80 Questions</option>
                    <option value="90">90 Questions</option>
                    <option value="100">100 Questions</option>
                </select>
            </div>

            <div class="modal-buttons">
                <button id="cancel-quiz-btn" class="btn-cancel">
                    Cancel
                </button>
                <button id="generate-quiz-modal-btn" class="btn-generate">
                    Generate Quiz
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Element References ---
        const mainContentForPdf = document.getElementById('main-content-for-pdf'); // Used for PDF capture
        const initialMessage = document.getElementById('initial-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessageDiv = document.getElementById('error-message');
        const errorTextSpan = document.getElementById('error-text'); // Corrected reference
        const quizQuestionsArea = document.getElementById('quiz-questions-area');
        const submitQuizBtnContainer = document.getElementById('submit-quiz-button-container');
        const submitQuizBtn = document.getElementById('submit-quiz-btn');
        const quizResultActions = document.getElementById('quiz-result-actions');
        const finalScoreText = document.getElementById('final-score-text');

        const floatingCreateQuizBtn = document.getElementById('floating-create-quiz-btn');
        const quizModal = document.getElementById('quiz-modal');
        const modalTopicInput = document.getElementById('modal-topic-input');
        const modalNumQuestionsSelect = document.getElementById('modal-num-questions-select');
        const cancelQuizBtn = document.getElementById('cancel-quiz-btn');
        const generateQuizModalBtn = document.getElementById('generate-quiz-modal-btn');

        const timerScoreDisplay = document.getElementById('timer-score-display');
        const timeLeftSpan = document.getElementById('time-left');
        const quizScoreSummary = document.getElementById('quiz-score-summary');
        const scoreValueSpan = document.getElementById('score-value');

        const createNewQuizBtn = document.getElementById('create-new-quiz-btn');
        const downloadQuizBtn = document.getElementById('download-quiz-btn');

        // --- Global Quiz State Variables ---
        let quizData = [];              // Stores the fetched quiz questions and answers
        let selectedAnswers = {};       // Stores user's selected answers {questionIndex: "Selected Option Text"}
        let quizSubmitted = false;      // True if the quiz has been submitted
        let score = 0;                  // User's current score
        let timeLeft = 0;               // Time remaining in seconds
        let quizActive = false;         // True if the quiz is currently running (timer active, inputs enabled)
        let timerIntervalId = null;     // ID for the timer interval
        let currentQuizTopic = '';      // Stores the topic for PDF filename

        // --- Utility Functions ---

        /**
         * Formats seconds into a "MM:SS" string.
         * @param {number} seconds - The number of seconds.
         * @returns {string} Formatted time string (e.g., "05:30").
         */
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        /**
         * Displays an error message in the dedicated error message area.
         * @param {string} message - The error message to display.
         */
        function displayError(message) {
            errorMessageDiv.classList.remove('hidden');
            errorTextSpan.textContent = message;
        }

        /**
         * Hides the error message area.
         */
        function hideError() {
            errorMessageDiv.classList.add('hidden');
            errorTextSpan.textContent = '';
        }

        /**
         * Displays the loading spinner and hides other main content areas.
         */
        function showLoading() {
            loadingSpinner.style.display = 'block';
            initialMessage.classList.add('hidden');
            quizQuestionsArea.innerHTML = ''; // Clear previous questions
            submitQuizBtnContainer.classList.add('hidden');
            quizResultActions.classList.add('hidden');
            timerScoreDisplay.classList.add('hidden');
            quizScoreSummary.classList.add('hidden');
        }

        /**
         * Hides the loading spinner.
         */
        function hideLoading() {
            loadingSpinner.style.display = 'none';
        }

        // --- Modal and UI State Management ---

        /**
         * Shows the quiz generation modal.
         * Resets modal inputs and focuses on the topic field.
         */
        function showCreateQuizModal() {
            quizModal.classList.remove('hidden');
            quizModal.style.display = 'flex'; // Ensure flex display overrides any 'display: none'
            modalTopicInput.value = '';
            modalNumQuestionsSelect.value = '10';
            modalTopicInput.focus();
        }

        /**
         * Hides the quiz generation modal.
         */
        function hideCreateQuizModal() {
            quizModal.classList.add('hidden');
            quizModal.style.display = ''; // Remove inline display style to let CSS rules apply normally
        }

        /**
         * Resets the entire quiz application to its initial, pre-quiz state.
         */
        function resetQuizApp() {
            quizData = [];
            selectedAnswers = {};
            quizSubmitted = false;
            score = 0;
            timeLeft = 0;
            quizActive = false;
            if (timerIntervalId) {
                clearInterval(timerIntervalId);
                timerIntervalId = null;
            }
            currentQuizTopic = '';

            hideError();
            hideLoading();
            quizQuestionsArea.innerHTML = '';
            initialMessage.classList.remove('hidden'); // Show initial message
            submitQuizBtnContainer.classList.add('hidden');
            quizResultActions.classList.add('hidden');
            timerScoreDisplay.classList.add('hidden');
            quizScoreSummary.classList.add('hidden');
            timeLeftSpan.textContent = '00:00'; // Reset timer display
            scoreValueSpan.textContent = '0 / 0'; // Reset score display
            finalScoreText.textContent = ''; // Clear final score text
        }

        // --- Timer Logic ---

        /**
         * Starts the quiz countdown timer.
         */
        function startTimer() {
            if (timerIntervalId) clearInterval(timerIntervalId);
            timerScoreDisplay.classList.remove('hidden');
            timeLeftSpan.textContent = formatTime(timeLeft);

            timerIntervalId = setInterval(() => {
                timeLeft--;
                timeLeftSpan.textContent = formatTime(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(timerIntervalId);
                    timerIntervalId = null;
                    if (quizActive) { // Only submit if quiz was active and timer ran out
                        handleSubmitQuiz();
                    }
                }
            }, 1000);
        }

        // --- Quiz Interaction Functions ---

        /**
         * Handles user selecting an option for a question.
         * Stores the selected answer and re-renders questions for visual updates.
         * @param {number} questionIndex - The index of the question.
         * @param {string} option - The text of the selected option.
         */
        function handleOptionSelect(questionIndex, option) {
            if (quizActive && !quizSubmitted) {
                selectedAnswers[questionIndex] = option;
                renderQuizQuestions(); // Re-render to update selection visual
            }
        }

        /**
         * Renders the quiz questions and options based on the current `quizData` and `selectedAnswers`.
         * Applies visual feedback for selections and correct answers after submission.
         */
        function renderQuizQuestions() {
            quizQuestionsArea.innerHTML = ''; // Clear existing questions
            if (!quizData || quizData.length === 0) return;

            quizData.forEach((q, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                questionCard.innerHTML = `
                    <p class="question-text">${index + 1}. ${q.question}</p>
                    <div class="options-group"></div>
                `;
                const optionsGroup = questionCard.querySelector('.options-group');

                q.options.forEach((option, optIndex) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'option';

                    const radioId = `q${index}-option${optIndex}`;
                    const inputElement = document.createElement('input');
                    inputElement.type = 'radio';
                    inputElement.name = `question${index}`;
                    inputElement.value = option;
                    inputElement.id = radioId;
                    inputElement.className = 'mr-3 accent-indigo-600 transform scale-125';

                    const labelElement = document.createElement('label');
                    labelElement.htmlFor = radioId;
                    labelElement.className = 'flex items-center p-3 bg-white border border-gray-300 rounded-md cursor-pointer transition-all duration-200';
                    labelElement.innerHTML = `${String.fromCharCode(65 + optIndex)}. ${option}`;

                    // Attach click listener to the label for visual update and radio check
                    labelElement.addEventListener('click', () => {
                        inputElement.checked = true; // Explicitly check radio button
                        handleOptionSelect(index, option);
                    });

                    // Set radio button as checked if it was previously selected
                    if (selectedAnswers[index] === option) {
                        inputElement.checked = true;
                    }

                    // Disable radio buttons if quiz is submitted or not active
                    if (!quizActive || quizSubmitted) {
                        inputElement.disabled = true;
                        labelElement.classList.add('opacity-70', 'cursor-not-allowed');
                    } else {
                         labelElement.classList.remove('opacity-70', 'cursor-not-allowed');
                    }

                    // Post-submission feedback: Apply classes for correct/incorrect visual cues
                    if (quizSubmitted) {
                        if (option === q.answer) {
                            labelElement.classList.add('correct-option');
                            labelElement.innerHTML += ' <span class="ml-auto text-green-600">✓ Correct</span>';
                        } else if (selectedAnswers[index] === option && selectedAnswers[index] !== q.answer) {
                            labelElement.classList.add('selected-incorrect-option');
                            labelElement.innerHTML += ' <span class="ml-auto text-red-600">✗ Your Answer</span>';
                        }
                    }

                    optionDiv.appendChild(inputElement);
                    optionDiv.appendChild(labelElement);
                    optionsGroup.appendChild(optionDiv);
                });

                // Add overall card border feedback after submission
                if (quizSubmitted) {
                    const hasAnswered = selectedAnswers[index] !== undefined;
                    const isCorrectOverall = selectedAnswers[index] === q.answer;

                    if (hasAnswered) {
                        if (isCorrectOverall) {
                            questionCard.classList.add('correct');
                        } else {
                            questionCard.classList.add('incorrect');
                        }
                    } else {
                        questionCard.classList.add('unanswered');
                    }
                }

                quizQuestionsArea.appendChild(questionCard);
            });

            // Show submit button if quiz is active and not submitted
            if (quizActive && !quizSubmitted && quizData.length > 0) {
                submitQuizBtnContainer.classList.remove('hidden');
            } else {
                submitQuizBtnContainer.classList.add('hidden');
            }
        }

        /**
         * Calculates the quiz score, stops the timer, and displays results.
         */
        function handleSubmitQuiz() {
            if (quizSubmitted) return; // Prevent multiple submissions
            quizActive = false;
            quizSubmitted = true;
            if (timerIntervalId) {
                clearInterval(timerIntervalId);
                timerIntervalId = null;
            }

            let newScore = 0;
            quizData.forEach((q, index) => {
                if (selectedAnswers[index] === q.answer) {
                    newScore += 1;
                }
            });
            score = newScore;
            renderQuizQuestions(); // Re-render to show correct/incorrect answers and disable inputs

            // Display final score and action buttons
            finalScoreText.textContent = `You scored ${score} out of ${quizData.length}!`;
            quizResultActions.classList.remove('hidden'); // Show results section

            // Update score display at the top
            quizScoreSummary.classList.remove('hidden');
            scoreValueSpan.textContent = `${score} / ${quizData.length}`;

            // Scroll to results for better UX
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        // --- API Call and Quiz Generation ---

        /**
         * Calls the Vercel proxy to generate quiz questions using the selected topic and number of questions.
         */
        async function generateQuestions() {
            const topic = modalTopicInput.value.trim();
            const numQuestions = parseInt(modalNumQuestionsSelect.value);

            if (!topic) {
                displayError('Please enter a quiz topic.');
                return;
            }

            currentQuizTopic = topic; // Store topic for PDF
            hideCreateQuizModal();
            hideError();
            showLoading();
            initialMessage.classList.add('hidden');

            // Point this to your Vercel serverless function, e.g., your-vercel-app-name.vercel.app/api/generate-quiz
            const proxyUrl = '/api/generate-quiz'; // Use a relative path for Vercel deployment

            try {
                const response = await fetchWithExponentialBackoff(proxyUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: topic,
                        numQuestions: numQuestions
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    if (Array.isArray(result) && result.length > 0) {
                        quizData = result;
                        selectedAnswers = {};
                        quizSubmitted = false;
                        score = 0;
                        timeLeft = numQuestions * 30; // 30 seconds per question
                        quizActive = true;
                        renderQuizQuestions();
                        startTimer();
                        initialMessage.classList.add('hidden');
                    } else {
                        throw new Error(result.error || 'Proxy returned an empty or invalid array of questions.');
                    }
                } else {
                    throw new Error(result.error || `Proxy server error: ${response.status}`);
                }
            } catch (error) {
                console.error('Error generating questions via proxy:', error);
                displayError(`Failed to generate questions: ${error.message}. Please ensure your Vercel API endpoint is set up correctly.`);
                quizData = null;
            } finally {
                hideLoading();
            }
        }

        /**
         * Utility function for making fetch requests with exponential backoff for retries.
         * Helps handle temporary network issues or rate limits.
         * @param {string} url - The URL to fetch from.
         * @param {object} options - Fetch options (method, headers, body, etc.).
         * @param {number} retries - Maximum number of retries.
         * @param {number} delay - Initial delay between retries in milliseconds.
         * @returns {Promise<Response>} The fetch response object.
         * @throws {Error} If all retries are exhausted or a non-retryable error occurs.
         */
        async function fetchWithExponentialBackoff(url, options, retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    } else if (response.status === 429 || response.status >= 500) { // Too Many Requests or Server Errors
                        console.warn(`Attempt ${i + 1} failed with status ${response.status}. Retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Double the delay for the next retry
                    } else {
                        // For other client errors (e.g., 400, 404), don't retry, just throw
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                    }
                } catch (error) {
                    if (i === retries - 1) {
                        throw error;
                    }
                    console.error(`Fetch error on attempt ${i + 1}:`, error.message);
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
            throw new Error('Max retries exceeded');
        }

        // --- PDF Download Function ---

        /**
         * Downloads the currently displayed quiz questions as a PDF document.
         * Uses html2canvas to capture the HTML content and jsPDF to generate the PDF.
         */
        function downloadQuizAsPdf() {
            if (!quizData || quizData.length === 0) {
                displayError("No quiz to download. Please generate a quiz first.");
                return;
            }

            // Temporarily hide elements not meant for PDF (like buttons, timer, modal)
            const elementsToHide = document.querySelectorAll('.hide-on-pdf');
            const originalDisplays = [];
            elementsToHide.forEach(el => {
                originalDisplays.push({ el: el, display: el.style.display });
                el.style.display = 'none';
            });

            // Use a small timeout to ensure DOM updates (hiding elements) are applied before capture
            setTimeout(() => {
                // Ensure the main container's background is white for PDF clarity
                const originalBg = mainContentForPdf.style.backgroundColor;
                mainContentForPdf.style.backgroundColor = '#ffffff';

                html2canvas(mainContentForPdf, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new window.jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210; // A4 width in mm
                    const pageHeight = 297; // A4 height in mm
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    pdf.save(`${currentQuizTopic || 'Generated'}_Quiz.pdf`);

                    // Restore original display styles and background color after PDF generation
                    originalDisplays.forEach(({ el, display }) => {
                        el.style.display = display;
                    });
                    mainContentForPdf.style.backgroundColor = originalBg;
                }).catch(error => {
                    console.error('Error generating PDF:', error);
                    displayError('Failed to download quiz. Please try again.');
                    // Ensure elements are restored even if an error occurs
                    originalDisplays.forEach(({ el, display }) => {
                        el.style.display = display;
                    });
                    mainContentForPdf.style.backgroundColor = originalBg;
                });
            }, 100); // Short delay for DOM repaint
        }


        // --- Event Listeners Initialization (on window load) ---
        window.onload = function() {
            // Initial state reset to ensure a clean start
            resetQuizApp();
            initialMessage.classList.remove('hidden'); // Ensure initial message is visible

            // Event listener for the floating "Create Quiz" button
            floatingCreateQuizBtn.addEventListener('click', () => {
                resetQuizApp(); // Reset all quiz state before opening modal
                showCreateQuizModal();
            });

            // Event listeners for modal buttons
            cancelQuizBtn.addEventListener('click', hideCreateQuizModal);
            generateQuizModalBtn.addEventListener('click', generateQuestions);

            // Event listeners for quiz interaction buttons
            submitQuizBtn.addEventListener('click', handleSubmitQuiz);
            createNewQuizBtn.addEventListener('click', () => {
                resetQuizApp(); // Reset everything
                showCreateQuizModal(); // Open modal for a new quiz
            });
            downloadQuizBtn.addEventListener('click', downloadQuizAsPdf);
        };
    </script>
</body>
</html>        }
        .btn-primary {
            background-color: #6366f1;
            color: #ffffff;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }
        .btn-primary:hover {
            background-color: #4f46e5;
            transform: translateY(-2px);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        .question-card {
            background-color: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            margin-bottom: 15px;
        }
        .question-card p.question-text {
            font-size: 1.15rem;
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 15px;
        }
        .question-card .option label {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .question-card .option label:hover {
            background-color: #eff6ff;
            border-color: #a7b4f5;
        }
        .question-card .option input[type="radio"] {
            margin-right: 12px;
            accent-color: #6366f1; /* Custom color for radio button */
            transform: scale(1.2); /* Slightly larger radio button */
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #6366f1;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none; /* Hidden by default */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .results-section {
            background-color: #ecfdf5; /* Light green background */
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #a7f3d0; /* Green border */
            text-align: center;
            display: none; /* Hidden by default */
        }
        .results-section h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #065f46; /* Dark green text */
            margin-bottom: 10px;
        }
        .results-section p {
            font-size: 1.1rem;
            color: #065f46;
        }
        .error-message {
            color: #ef4444; /* Red color for errors */
            background-color: #fee2e2;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #fca5a5;
            margin-top: 15px;
            display: none;
            font-weight: 500;
        }

        /* Styles for the new floating button and modal */
        .floating-button {
            position: fixed;
            bottom: 24px; /* 6 * 4px = 24px */
            right: 24px; /* 6 * 4px = 24px */
            background-color: #6366f1;
            color: #ffffff;
            font-weight: 800; /* Extra bold */
            padding: 16px 32px; /* py-4 px-8 */
            border-radius: 9999px; /* rounded-full */
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.4); /* shadow-lg */
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            z-index: 50; /* Ensure it's above other content */
        }
        .floating-button:hover {
            background-color: #4f46e5;
            transform: translateY(-4px) scale(1.05); /* Slightly move up and scale */
            box-shadow: 0 15px 30px rgba(99, 102, 241, 0.5);
        }
        .floating-button:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3);
        }
        .floating-button svg {
            width: 24px;
            height: 24px;
            margin-right: 8px;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* bg-gray-900 bg-opacity-70 */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 60; /* Higher than floating button */
            opacity: 0;
            animation: fadeIn 0.3s ease-out forwards;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 32px; /* p-8 */
            border-radius: 24px; /* rounded-3xl */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); /* shadow-2xl */
            width: 90%;
            max-width: 448px; /* max-w-md */
            transform: translateY(20px) scale(0.95);
            animation: slideUp 0.3s ease-out forwards;
            position: relative;
            z-index: 70; /* Highest z-index */
        }
        .modal-content h2 {
            font-size: 2rem; /* text-3xl */
            font-weight: 700; /* font-bold */
            color: #1f2937; /* text-gray-900 */
            margin-bottom: 24px; /* mb-6 */
            text-align: center;
        }
        .modal-content .input-group label {
            font-size: 1.125rem; /* text-lg */
        }
        .modal-content .input-group input,
        .modal-content .input-group select {
            border-radius: 12px; /* rounded-xl */
            padding: 12px 16px; /* py-3 px-4 */
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end; /* justify-end */
            gap: 16px; /* space-x-4 */
            margin-top: 28px; /* mb-7 in modal */
        }
        .btn-cancel {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #374151; /* text-gray-800 */
            font-weight: 600; /* font-semibold */
            padding: 12px 24px; /* py-3 px-6 */
            border-radius: 12px; /* rounded-xl */
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        .btn-cancel:hover {
            background-color: #d1d5db; /* hover:bg-gray-300 */
        }
        .btn-generate {
            background-color: #10b981; /* bg-green-600 */
            color: #ffffff;
            font-weight: 800; /* font-extrabold */
            padding: 12px 24px; /* py-3 px-6 */
            border-radius: 12px; /* rounded-xl */
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); /* shadow-lg */
        }
        .btn-generate:hover {
            background-color: #059669; /* hover:bg-green-700 */
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.4);
        }

        /* Timer and Score display */
        .timer-score-box {
            background-color: #e0f2fe; /* bg-blue-50 */
            padding: 16px; /* p-4 */
            border-radius: 8px; /* rounded-lg */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06); /* shadow-inner */
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px; /* mb-6 */
        }
        .timer-score-box .label {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            color: #1e40af; /* text-blue-800 */
        }
        .timer-score-box .value {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700; /* font-bold */
        }

        /* Styling for correct/incorrect answers */
        .question-card.correct {
            border-color: #10B981; /* green-500 */
            background-color: #ECFDF5; /* green-50 */
        }
        .question-card.incorrect {
            border-color: #EF4444; /* red-500 */
            background-color: #FEE2E2; /* red-50 */
        }
        .question-card.unanswered {
            border-color: #F59E0B; /* yellow-500 */
            background-color: #FFFBEB; /* yellow-50 */
        }

        .option label.correct-option {
            background-color: #D1FAE5 !important; /* light green */
            border-color: #34D399 !important; /* green-400 */
            font-weight: 600;
        }
        .option label.selected-incorrect-option {
            background-color: #FEE2E2 !important; /* light red */
            border-color: #EF4444 !important; /* red-400 */
            font-weight: 600;
        }

        /* Elements to hide during PDF generation */
        .hide-on-pdf {
            /* This class will be programmatically controlled by JS */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">📝 Objective Question Generator</h1>

        <!-- Timer and Score Display -->
        <div id="timer-score-display" class="timer-score-box hidden hide-on-pdf">
            <div class="label">
                Time Left: <span id="time-left" class="value text-blue-800">00:00</span>
            </div>
            <div id="quiz-score-summary" class="label hidden">
                Your Score: <span id="score-value" class="value text-purple-800">0 / 0</span>
            </div>
        </div>

        <!-- Initial Message (visible before quiz generation) -->
        <div id="initial-message" class="text-center py-12">
            <p class="text-xl text-gray-500 font-medium">
                Click the "Create Quiz" button to generate a new quiz!
            </p>
            <p class="mt-2 text-md text-gray-400">
                You can specify the topic and number of questions.
            </p>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-spinner" class="loading-spinner"></div>

        <!-- Error Message Display -->
        <div id="error-message" class="error-message"></div>

        <!-- Quiz Questions Area (Dynamically Populated) -->
        <div id="quiz-questions-area" class="mt-5">
            <!-- Questions will be loaded here -->
        </div>

        <!-- Submit Quiz Button -->
        <div id="submit-quiz-button-container" class="flex justify-center mt-4 hidden hide-on-pdf">
            <button id="submit-quiz-btn" class="btn btn-primary w-full max-w-xs">Submit Answers</button>
        </div>

        <!-- Quiz Result and Action Buttons -->
        <div id="quiz-result-actions" class="results-section mt-5 hidden">
            <h2 class="text-3xl font-bold text-gray-900">Quiz Completed!</h2>
            <p id="final-score-text" class="text-xl font-bold text-green-600 mb-4"></p>
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 hide-on-pdf">
                <button id="create-new-quiz-btn" class="btn btn-primary bg-blue-600 hover:bg-blue-700 w-full sm:w-auto">
                    Create New Quiz
                </button>
                <button id="download-quiz-btn" class="btn btn-primary bg-gray-700 hover:bg-gray-800 w-full sm:w-auto">
                    Download Quiz (PDF)
                </button>
            </div>
        </div>
    </div>

    <!-- Floating Create Quiz Button -->
    <button id="floating-create-quiz-btn" class="floating-button hide-on-pdf">
        <svg class="w-6 h-6 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
        Create Quiz
    </button>

    <!-- Quiz Generation Modal -->
    <div id="quiz-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">Generate New Quiz</h2>

            <div class="input-group mb-5">
                <label for="modal-topic-input">Quiz Topic:</label>
                <input
                    type="text"
                    id="modal-topic-input"
                    placeholder="e.g., World History, Science, JavaScript"
                    class="focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
                    autofocus
                />
            </div>

            <div class="input-group mb-7">
                <label for="modal-num-questions-select">Number of Questions:</label>
                <select
                    id="modal-num-questions-select"
                    class="focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
                >
                    <option value="10">10 Questions</option>
                    <option value="20">20 Questions</option>
                    <option value="30">30 Questions</option>
                    <option value="40">40 Questions</option>
                    <option value="50">50 Questions</option>
                    <option value="60">60 Questions</option>
                    <option value="70">70 Questions</option>
                    <option value="80">80 Questions</option>
                    <option value="90">90 Questions</option>
                    <option value="100">100 Questions</option>
                </select>
            </div>

            <div class="modal-buttons">
                <button id="cancel-quiz-btn" class="btn-cancel">
                    Cancel
                </button>
                <button id="generate-quiz-modal-btn" class="btn-generate">
                    Generate Quiz
                </button>
            </div>
        </div>
    </div>

    <script>
        // DOM Element references
        const quizContainer = document.getElementById('quiz-container');
        const initialMessage = document.getElementById('initial-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessageDiv = document.getElementById('error-message');
        const errorTextSpan = document.getElementById('error-message'); // Reuse existing ID for text
        const quizQuestionsArea = document.getElementById('quiz-questions-area');
        const submitQuizBtnContainer = document.getElementById('submit-quiz-button-container');
        const submitQuizBtn = document.getElementById('submit-quiz-btn');
        const quizResultActions = document.getElementById('quiz-result-actions');
        const finalScoreText = document.getElementById('final-score-text');

        const floatingCreateQuizBtn = document.getElementById('floating-create-quiz-btn');
        const quizModal = document.getElementById('quiz-modal');
        const modalTopicInput = document.getElementById('modal-topic-input'); // Renamed for clarity
        const modalNumQuestionsSelect = document.getElementById('modal-num-questions-select'); // Renamed
        const cancelQuizBtn = document.getElementById('cancel-quiz-btn');
        const generateQuizModalBtn = document.getElementById('generate-quiz-modal-btn');

        const timerScoreDisplay = document.getElementById('timer-score-display');
        const timeLeftSpan = document.getElementById('time-left');
        const quizScoreSummary = document.getElementById('quiz-score-summary'); // New element for overall score display
        const scoreValueSpan = document.getElementById('score-value');

        const createNewQuizBtn = document.getElementById('create-new-quiz-btn');
        const downloadQuizBtn = document.getElementById('download-quiz-btn');

        // Global variables for quiz state
        let quizData = []; // Store the questions and correct answers
        let selectedAnswers = {}; // Store user's selected answers {questionIndex: "Selected Option Text"}
        let quizSubmitted = false;
        let score = 0;
        let timeLeft = 0; // Time in seconds
        let quizActive = false; // Is the quiz currently running?
        let timerIntervalId = null;
        let currentQuizTopic = ''; // Store the topic for PDF filename

        // --- Utility Functions ---

        /**
         * Formats seconds into MM:SS string.
         * @param {number} seconds - The number of seconds.
         * @returns {string} Formatted time string.
         */
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        /**
         * Displays an error message to the user.
         * @param {string} message - The error message to display.
         */
        function displayError(message) {
            errorMessageDiv.classList.remove('hidden');
            errorTextSpan.textContent = message;
        }

        /**
         * Hides the error message.
         */
        function hideError() {
            errorMessageDiv.classList.add('hidden');
            errorTextSpan.textContent = '';
        }

        /**
         * Displays the loading indicator.
         */
        function showLoading() {
            loadingSpinner.style.display = 'block';
            initialMessage.classList.add('hidden');
            quizQuestionsArea.innerHTML = ''; // Clear previous questions
            submitQuizBtnContainer.classList.add('hidden');
            quizResultActions.classList.add('hidden');
            timerScoreDisplay.classList.add('hidden');
            quizScoreSummary.classList.add('hidden'); // Hide score summary at top
        }

        /**
         * Hides the loading indicator.
         */
        function hideLoading() {
            loadingSpinner.style.display = 'none';
        }

        // --- Quiz Modals and UI State Management ---

        /**
         * Shows the quiz generation modal.
         */
        function showCreateQuizModal() {
            quizModal.classList.remove('hidden');
            // Reset modal inputs when shown
            modalTopicInput.value = '';
            modalNumQuestionsSelect.value = '10';
            modalTopicInput.focus(); // Focus on the topic input
        }

        /**
         * Hides the quiz generation modal.
         */
        function hideCreateQuizModal() {
            quizModal.classList.add('hidden');
        }

        /**
         * Resets the entire quiz application to its initial state.
         */
        function resetQuizApp() {
            quizData = [];
            selectedAnswers = {};
            quizSubmitted = false;
            score = 0;
            timeLeft = 0;
            quizActive = false;
            if (timerIntervalId) {
                clearInterval(timerIntervalId);
                timerIntervalId = null;
            }
            currentQuizTopic = '';

            hideError();
            hideLoading();
            quizQuestionsArea.innerHTML = '';
            initialMessage.classList.remove('hidden'); // Show initial message
            submitQuizBtnContainer.classList.add('hidden');
            quizResultActions.classList.add('hidden');
            timerScoreDisplay.classList.add('hidden');
            quizScoreSummary.classList.add('hidden'); // Hide score summary at top
            timeLeftSpan.textContent = '00:00'; // Reset timer display
            scoreValueSpan.textContent = '0 / 0'; // Reset score display
            finalScoreText.textContent = ''; // Clear final score text
        }

        // --- Timer Logic ---

        /**
         * Starts the quiz timer.
         */
        function startTimer() {
            if (timerIntervalId) clearInterval(timerIntervalId); // Clear any existing timer
            timerScoreDisplay.classList.remove('hidden');
            timeLeftSpan.textContent = formatTime(timeLeft); // Initial display

            timerIntervalId = setInterval(() => {
                timeLeft--;
                timeLeftSpan.textContent = formatTime(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(timerIntervalId);
                    timerIntervalId = null;
                    if (quizActive) { // Only submit if quiz was active
                        handleSubmitQuiz();
                    }
                }
            }, 1000);
        }

        // --- Quiz Interaction Functions ---

        /**
         * Handles the selection of an option for a question.
         * @param {number} questionIndex - The index of the question.
         * @param {string} option - The selected option text.
         */
        function handleOptionSelect(questionIndex, option) {
            if (quizActive && !quizSubmitted) {
                selectedAnswers[questionIndex] = option;
                renderQuizQuestions(); // Re-render to update selection visual and enable submit button
            }
        }

        /**
         * Renders the quiz questions based on `quizData` and `selectedAnswers`.
         */
        function renderQuizQuestions() {
            quizQuestionsArea.innerHTML = ''; // Clear existing questions
            if (!quizData || quizData.length === 0) return;

            quizData.forEach((q, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card'; // Re-using your existing class
                questionCard.innerHTML = `
                    <p class="question-text">${index + 1}. ${q.question}</p>
                    <div class="options-group"></div>
                `;
                const optionsGroup = questionCard.querySelector('.options-group');

                q.options.forEach((option, optIndex) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'option';

                    const radioId = `q${index}-option${optIndex}`;
                    const inputElement = document.createElement('input');
                    inputElement.type = 'radio';
                    inputElement.name = `question${index}`;
                    inputElement.value = option;
                    inputElement.id = radioId;
                    inputElement.className = 'mr-3 accent-indigo-600 transform scale-125'; // Tailwind + custom scale

                    const labelElement = document.createElement('label');
                    labelElement.htmlFor = radioId;
                    labelElement.className = 'flex items-center p-3 bg-white border border-gray-300 rounded-md cursor-pointer transition-all duration-200';
                    labelElement.innerHTML = `${String.fromCharCode(65 + optIndex)}. ${option}`;

                    // Attach click listener to the label for visual update
                    labelElement.addEventListener('click', () => {
                        // Ensure the radio button is checked when label is clicked
                        inputElement.checked = true;
                        handleOptionSelect(index, option);
                    });

                    if (selectedAnswers[index] === option) {
                        inputElement.checked = true;
                    }

                    // Disable radio buttons if quiz is submitted or not active
                    if (!quizActive || quizSubmitted) {
                        inputElement.disabled = true;
                        labelElement.classList.add('opacity-70', 'cursor-not-allowed');
                    } else {
                         labelElement.classList.remove('opacity-70', 'cursor-not-allowed');
                    }

                    // Post-submission feedback
                    if (quizSubmitted) {
                        if (option === q.answer) {
                            labelElement.classList.add('correct-option');
                            labelElement.innerHTML += ' <span class="ml-auto text-green-600">✓ Correct</span>';
                        } else if (selectedAnswers[index] === option && selectedAnswers[index] !== q.answer) {
                            labelElement.classList.add('selected-incorrect-option');
                             labelElement.innerHTML += ' <span class="ml-auto text-red-600">✗ Your Answer</span>';
                        }
                    }

                    optionDiv.appendChild(inputElement);
                    optionDiv.appendChild(labelElement); // Append label after input
                    optionsGroup.appendChild(optionDiv);
                });

                // Add overall card border feedback after submission
                if (quizSubmitted) {
                    const hasAnswered = selectedAnswers[index] !== undefined;
                    const isCorrectOverall = selectedAnswers[index] === q.answer;

                    if (hasAnswered) {
                        if (isCorrectOverall) {
                            questionCard.classList.add('correct');
                        } else {
                            questionCard.classList.add('incorrect');
                        }
                    } else {
                        questionCard.classList.add('unanswered');
                    }
                }

                quizQuestionsArea.appendChild(questionCard);
            });

            // Show submit button if quiz is active and not submitted
            if (quizActive && !quizSubmitted && quizData.length > 0) {
                submitQuizBtnContainer.classList.remove('hidden');
            } else {
                submitQuizBtnContainer.classList.add('hidden');
            }
        }

        /**
         * Calculates the score and updates UI.
         */
        function handleSubmitQuiz() {
            if (quizSubmitted) return; // Prevent multiple submissions
            quizActive = false;
            quizSubmitted = true;
            if (timerIntervalId) {
                clearInterval(timerIntervalId);
                timerIntervalId = null;
            }

            let newScore = 0;
            quizData.forEach((q, index) => {
                if (selectedAnswers[index] === q.answer) {
                    newScore += 1;
                }
            });
            score = newScore;
            renderQuizQuestions(); // Re-render to show correct/incorrect answers and disable inputs

            // Display final score and action buttons
            finalScoreText.textContent = `You scored ${score} out of ${quizData.length}!`;
            quizResultActions.classList.remove('hidden'); // Show results section

            // Update score display at the top
            quizScoreSummary.classList.remove('hidden');
            scoreValueSpan.textContent = `${score} / ${quizData.length}`;

            // Scroll to results
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        // --- API Call and Quiz Generation ---

        /**
         * Calls the Vercel proxy to generate quiz questions.
         */
        async function generateQuestions() {
            const topic = modalTopicInput.value.trim();
            const numQuestions = parseInt(modalNumQuestionsSelect.value);

            if (!topic) {
                displayError('Please enter a quiz topic.');
                return;
            }

            currentQuizTopic = topic; // Store topic for PDF
            hideCreateQuizModal();
            hideError();
            showLoading();
            initialMessage.classList.add('hidden'); // Ensure initial message is hidden

            // Point this to your Vercel serverless function
            // When deployed, this will be your-vercel-app-name.vercel.app/api/generate-quiz
            const proxyUrl = '/api/generate-quiz'; // Use a relative path for Vercel deployment

            try {
                const response = await fetchWithExponentialBackoff(proxyUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // Send topic and numQuestions directly. The backend will build the prompt.
                    body: JSON.stringify({
                        topic: topic,
                        numQuestions: numQuestions
                    })
                });

                const result = await response.json(); // Parse the JSON response from your proxy

                if (response.ok) { // Check if your proxy's response was successful (HTTP 2xx)
                    // The proxy should return an array of question objects directly
                    if (Array.isArray(result) && result.length > 0) {
                        quizData = result; // Store the fetched quiz data
                        selectedAnswers = {}; // Reset selected answers for new quiz
                        quizSubmitted = false; // Reset submitted state
                        score = 0; // Reset score
                        timeLeft = numQuestions * 30; // Set timer: 30 seconds per question
                        quizActive = true; // Activate the quiz
                        renderQuizQuestions(); // Display the questions
                        startTimer(); // Start the timer
                        initialMessage.classList.add('hidden'); // Ensure initial message is hidden
                    } else {
                        throw new Error(result.error || 'Proxy returned an empty or invalid array of questions.');
                    }
                } else {
                    // If the proxy returns an error status (e.g., 400, 500)
                    throw new Error(result.error || `Proxy server error: ${response.status}`);
                }
            } catch (error) {
                console.error('Error generating questions via proxy:', error);
                displayError(`Failed to generate questions: ${error.message}. Please try again.`);
                quizData = null;
            } finally {
                hideLoading();
            }
        }

        /**
         * Utility function for exponential backoff during API calls.
         * @param {string} url - The URL to fetch from.
         * @param {object} options - Fetch options.
         * @param {number} retries - Number of retries.
         * @param {number} delay - Initial delay in ms.
         * @returns {Promise<Response>} The fetch response.
         */
        async function fetchWithExponentialBackoff(url, options, retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    } else if (response.status === 429 || response.status >= 500) { // Too Many Requests or Server Errors
                        console.warn(`Attempt ${i + 1} failed with status ${response.status}. Retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Double the delay for the next retry
                    } else {
                        // For other client errors (e.g., 400, 404), don't retry, just throw
                        const errorData = await response.json().catch(() => ({})); // Try to parse error, fall back to empty object
                        throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                    }
                } catch (error) {
                    if (i === retries - 1) {
                        throw error; // Throw if all retries are exhausted
                    }
                    console.error(`Fetch error on attempt ${i + 1}:`, error.message);
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
            throw new Error('Max retries exceeded');
        }

        // --- PDF Download Function ---

        /**
         * Downloads the quiz content as a PDF.
         */
        function downloadQuizAsPdf() {
            if (!quizData || quizData.length === 0) {
                displayError("No quiz to download. Please generate a quiz first.");
                return;
            }

            // Temporarily hide elements not meant for PDF
            const elementsToHide = document.querySelectorAll('.hide-on-pdf');
            const originalDisplays = [];
            elementsToHide.forEach(el => {
                originalDisplays.push({ el: el, display: el.style.display });
                el.style.display = 'none';
            });

            // Use a small timeout to ensure DOM updates (hiding elements) are applied
            setTimeout(() => {
                // Ensure the main container's background is white for PDF clarity
                const originalBg = quizContainer.style.backgroundColor;
                quizContainer.style.backgroundColor = '#ffffff';

                html2canvas(quizContainer, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new window.jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210; // A4 width in mm
                    const pageHeight = 297; // A4 height in mm
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    pdf.save(`${currentQuizTopic || 'Generated'}_Quiz.pdf`);

                    // Restore original display styles and background color
                    originalDisplays.forEach(({ el, display }) => {
                        el.style.display = display;
                    });
                    quizContainer.style.backgroundColor = originalBg; // Restore original background
                }).catch(error => {
                    console.error('Error generating PDF:', error);
                    displayError('Failed to download quiz. Please try again.');
                    // Ensure elements are restored even if an error occurs
                    originalDisplays.forEach(({ el, display }) => {
                        el.style.display = display;
                    });
                    quizContainer.style.backgroundColor = originalBg; // Restore original background
                });
            }, 100); // Short delay for DOM repaint
        }


        // --- Event Listeners ---
        window.onload = function() {
            // Initial state reset
            resetQuizApp();
            initialMessage.classList.remove('hidden'); // Make sure initial message is visible on load

            floatingCreateQuizBtn.addEventListener('click', () => {
                resetQuizApp(); // Reset everything before showing modal
                showCreateQuizModal();
            });
            cancelQuizBtn.addEventListener('click', hideCreateQuizModal);
            generateQuizModalBtn.addEventListener('click', generateQuestions); // This now calls the integrated function
            submitQuizBtn.addEventListener('click', handleSubmitQuiz);
            createNewQuizBtn.addEventListener('click', () => {
                resetQuizApp();
                showCreateQuizModal();
            });
            downloadQuizBtn.addEventListener('click', downloadQuizAsPdf);
        };
    </script>
</body>
</html>
